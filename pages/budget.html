<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .stats { padding: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat { background: var(--tg-theme-secondary-bg-color); padding: 15px; border-radius: 12px; text-align: center; }
        .stat .value { font-size: 24px; font-weight: bold; color: var(--tg-theme-button-color); }
        .stat .label { font-size: 12px; opacity: 0.7; margin-top: 5px; }
        .content { padding: 15px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
        .trend-card { background: var(--tg-theme-secondary-bg-color); padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .trend-card.up { border-left: 3px solid #ef4444; }
        .trend-card.down { border-left: 3px solid #10b981; }
        .product-name { font-weight: 600; margin-bottom: 5px; }
        .store { font-size: 12px; opacity: 0.7; margin-bottom: 8px; }
        .prices { display: flex; gap: 15px; font-size: 14px; }
        .loading { text-align: center; padding: 20px; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</h1>
    </div>
    
    <div class="stats">
        <div class="stat">
            <div class="value" id="total">-</div>
            <div class="label">–†–∞—Å—Ö–æ–¥—ã</div>
        </div>
        <div class="stat">
            <div class="value" id="purchases">-</div>
            <div class="label">–ü–æ–∫—É–ø–æ–∫</div>
        </div>
        <div class="stat">
            <div class="value" id="products">-</div>
            <div class="label">–¢–æ–≤–∞—Ä–æ–≤</div>
        </div>
        <div class="stat">
            <div class="value" id="stores">-</div>
            <div class="label">–ú–∞–≥–∞–∑–∏–Ω–æ–≤</div>
        </div>
    </div>
    
    <div class="content">
        <div class="section-title">üìà –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω (7 –¥–Ω–µ–π)</div>
        <div id="trends"></div>
    </div>
    
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.show();
        tg.BackButton.onClick(() => window.history.back());
        
        async function loadData() {
            try {
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                const stats = await API.getStatistics();
                document.getElementById('total').textContent = 
                    Math.round(stats.total_spent / 1000) + 'K ‚Ç≤';
                document.getElementById('purchases').textContent = stats.total_purchases;
                document.getElementById('products').textContent = stats.unique_products;
                document.getElementById('stores').textContent = stats.unique_stores;
                
                // –¢—Ä–µ–Ω–¥—ã
                const trends = await API.getPriceTrends(7, 10);
                const trendsHTML = trends.map(t => `
                    <div class="trend-card ${t.trend_direction}">
                        <div class="product-name">${t.product_name}</div>
                        <div class="store">üè™ ${t.store_name}</div>
                        <div class="prices">
                            <span><strong>${t.current_price.toFixed(0)} ‚Ç≤</strong></span>
                            ${t.previous_price ? `
                                <span style="opacity:0.7">${t.previous_price.toFixed(0)} ‚Ç≤</span>
                                <span style="color:${t.trend_direction==='up'?'#ef4444':'#10b981'}">
                                    ${t.trend_direction==='up'?'üìà':'üìâ'} ${Math.abs(t.percent_change).toFixed(1)}%
                                </span>
                            ` : '<span>üÜï –ù–æ–≤—ã–π</span>'}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('trends').innerHTML = trendsHTML;
                tg.HapticFeedback.notificationOccurred('success');
            } catch (error) {
                console.error(error);
                document.getElementById('trends').innerHTML = 
                    '<div class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
                tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
            }
        }
        
        loadData();
        
        // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        tg.MainButton.setText('üîÑ –û–±–Ω–æ–≤–∏—Ç—å');
        tg.MainButton.show();
        tg.MainButton.onClick(() => {
            loadData();
            tg.HapticFeedback.impactOccurred('light');
        });
    </script>
</body>
</html>
